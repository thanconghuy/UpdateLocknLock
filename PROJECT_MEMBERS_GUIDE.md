# HÆ°á»›ng Dáº«n Quáº£n LÃ½ ThÃ nh ViÃªn Dá»± Ãn (Project Members Management)

## Tá»•ng Quan

Module Quáº£n LÃ½ ThÃ nh ViÃªn Dá»± Ãn cho phÃ©p quáº£n trá»‹ viÃªn vÃ  ngÆ°á»i quáº£n lÃ½ dá»± Ã¡n thÃªm, xÃ³a vÃ  phÃ¢n quyá»n cÃ¡c thÃ nh viÃªn trong tá»«ng dá»± Ã¡n. Module nÃ y Ä‘Æ°á»£c xÃ¢y dá»±ng láº¡i hoÃ n toÃ n vá»›i kiáº¿n trÃºc 4 cáº¥p Ä‘á»™ vai trÃ² rÃµ rÃ ng.

## Há»‡ Thá»‘ng 4 Cáº¥p Äá»™ Vai TrÃ²

### 1. Admin (Quáº£n trá»‹ viÃªn) - Level 100
**Quyá»n háº¡n:**
- Tháº¥y táº¥t cáº£ ngÆ°á»i dÃ¹ng trong há»‡ thá»‘ng
- CÃ³ thá»ƒ phÃ¢n quyá»n táº¥t cáº£ cÃ¡c vai trÃ² (Admin, Manager, Editor, Viewer)
- Quáº£n lÃ½ toÃ n bá»™ thÃ nh viÃªn trong má»i dá»± Ã¡n
- Truy cáº­p táº¥t cáº£ cÃ¡c chá»©c nÄƒng cá»§a há»‡ thá»‘ng

**Chá»©c nÄƒng:**
- ThÃªm/xÃ³a thÃ nh viÃªn
- PhÃ¢n quyá»n báº¥t ká»³ vai trÃ² nÃ o
- Xem danh sÃ¡ch táº¥t cáº£ thÃ nh viÃªn
- Quáº£n lÃ½ cÃ i Ä‘áº·t dá»± Ã¡n

### 2. Manager (Quáº£n lÃ½) - Level 80
**Quyá»n háº¡n:**
- Tháº¥y ngÆ°á»i dÃ¹ng cÃ³ vai trÃ²: Manager, Editor, Viewer (KHÃ”NG tháº¥y Admin)
- CÃ³ thá»ƒ phÃ¢n quyá»n cÃ¡c vai trÃ²: Manager, Editor, Viewer (KHÃ”NG thá»ƒ phÃ¢n Admin)
- Quáº£n lÃ½ thÃ nh viÃªn trong dá»± Ã¡n Ä‘Æ°á»£c phÃ¢n quyá»n
- Truy cáº­p cÃ¡c chá»©c nÄƒng quáº£n lÃ½ dá»± Ã¡n

**Chá»©c nÄƒng:**
- ThÃªm/xÃ³a thÃ nh viÃªn (trá»« Admin)
- PhÃ¢n quyá»n Manager, Editor, Viewer
- Xem danh sÃ¡ch thÃ nh viÃªn
- Quáº£n lÃ½ sáº£n pháº©m vÃ  cÃ¡c module khÃ¡c

### 3. Editor (BiÃªn táº­p viÃªn) - Level 60
**Quyá»n háº¡n:**
- Chá»‰ xem Ä‘Æ°á»£c dá»± Ã¡n Ä‘Æ°á»£c phÃ¢n quyá»n
- Thao tÃ¡c cÃ¡c chá»©c nÄƒng trong trang Products
- KHÃ”NG Ä‘Æ°á»£c thÃªm/xÃ³a thÃ nh viÃªn
- KHÃ”NG tháº¥y nÃºt "ğŸ‘¥ ThÃ nh viÃªn"

**Chá»©c nÄƒng:**
- Xem vÃ  chá»‰nh sá»­a sáº£n pháº©m
- Thao tÃ¡c dá»¯ liá»‡u trong dá»± Ã¡n
- KhÃ´ng cÃ³ quyá»n quáº£n lÃ½ thÃ nh viÃªn

### 4. Viewer (NgÆ°á»i xem) - Level 40
**Quyá»n háº¡n:**
- Chá»‰ xem Ä‘Æ°á»£c dá»± Ã¡n Ä‘Æ°á»£c phÃ¢n quyá»n
- CHá»ˆ xem, KHÃ”NG Ä‘Æ°á»£c chá»‰nh sá»­a
- KHÃ”NG Ä‘Æ°á»£c thÃªm/xÃ³a thÃ nh viÃªn
- KHÃ”NG tháº¥y nÃºt "ğŸ‘¥ ThÃ nh viÃªn"

**Chá»©c nÄƒng:**
- Xem sáº£n pháº©m (read-only)
- KhÃ´ng cÃ³ quyá»n chá»‰nh sá»­a hoáº·c quáº£n lÃ½

## Ma Tráº­n Quyá»n Háº¡n

| Chá»©c nÄƒng | Admin | Manager | Editor | Viewer |
|-----------|-------|---------|--------|--------|
| Tháº¥y Admin users | âœ… | âŒ | âŒ | âŒ |
| Tháº¥y Manager users | âœ… | âœ… | âŒ | âŒ |
| Tháº¥y Editor users | âœ… | âœ… | âœ… | âŒ |
| Tháº¥y Viewer users | âœ… | âœ… | âœ… | âœ… |
| PhÃ¢n quyá»n Admin | âœ… | âŒ | âŒ | âŒ |
| PhÃ¢n quyá»n Manager | âœ… | âœ… | âŒ | âŒ |
| PhÃ¢n quyá»n Editor | âœ… | âœ… | âŒ | âŒ |
| PhÃ¢n quyá»n Viewer | âœ… | âœ… | âŒ | âŒ |
| ThÃªm thÃ nh viÃªn | âœ… | âœ… | âŒ | âŒ |
| XÃ³a thÃ nh viÃªn | âœ… | âœ… | âŒ | âŒ |
| NÃºt "ğŸ‘¥ ThÃ nh viÃªn" | âœ… | âœ… | âŒ | âŒ |
| Chá»‰nh sá»­a sáº£n pháº©m | âœ… | âœ… | âœ… | âŒ |
| Xem sáº£n pháº©m | âœ… | âœ… | âœ… | âœ… |

## HÆ°á»›ng Dáº«n Sá»­ Dá»¥ng

### 1. ThÃªm ThÃ nh ViÃªn VÃ o Dá»± Ãn

**BÆ°á»›c 1:** ÄÄƒng nháº­p vá»›i tÃ i khoáº£n Admin hoáº·c Manager

**BÆ°á»›c 2:** Chá»n dá»± Ã¡n cáº§n quáº£n lÃ½ thÃ nh viÃªn

**BÆ°á»›c 3:** Click nÃºt "ğŸ‘¥ ThÃ nh viÃªn" (chá»‰ hiá»‡n vá»›i Admin/Manager)

**BÆ°á»›c 4:** Click nÃºt "â• ThÃªm thÃ nh viÃªn"

**BÆ°á»›c 5:** Chá»n ngÆ°á»i dÃ¹ng tá»« dropdown
- Admin: Tháº¥y táº¥t cáº£ ngÆ°á»i dÃ¹ng
- Manager: Chá»‰ tháº¥y Manager, Editor, Viewer

**BÆ°á»›c 6:** Chá»n vai trÃ² cho thÃ nh viÃªn
- Admin: CÃ³ thá»ƒ chá»n táº¥t cáº£ vai trÃ²
- Manager: Chá»‰ cÃ³ thá»ƒ chá»n Manager, Editor, Viewer

**BÆ°á»›c 7:** Click "LÆ°u"

### 2. XÃ³a ThÃ nh ViÃªn Khá»i Dá»± Ãn

**BÆ°á»›c 1:** Má»Ÿ modal "Quáº£n lÃ½ thÃ nh viÃªn"

**BÆ°á»›c 2:** TÃ¬m thÃ nh viÃªn cáº§n xÃ³a trong danh sÃ¡ch

**BÆ°á»›c 3:** Click nÃºt "XÃ³a" bÃªn cáº¡nh tÃªn thÃ nh viÃªn

**BÆ°á»›c 4:** XÃ¡c nháº­n xÃ³a

**LÆ°u Ã½:** ThÃ nh viÃªn bá»‹ xÃ³a sáº½ cÃ³ `status = 'removed'` trong database (soft delete)

### 3. Thay Äá»•i Vai TrÃ² ThÃ nh ViÃªn

**BÆ°á»›c 1:** Má»Ÿ modal "Quáº£n lÃ½ thÃ nh viÃªn"

**BÆ°á»›c 2:** TÃ¬m thÃ nh viÃªn cáº§n thay Ä‘á»•i vai trÃ²

**BÆ°á»›c 3:** Click vÃ o dropdown vai trÃ² hiá»‡n táº¡i

**BÆ°á»›c 4:** Chá»n vai trÃ² má»›i (theo quyá»n háº¡n cá»§a báº¡n)

**BÆ°á»›c 5:** Thay Ä‘á»•i Ä‘Æ°á»£c lÆ°u tá»± Ä‘á»™ng

### 4. ThÃªm Láº¡i ThÃ nh ViÃªn ÄÃ£ XÃ³a

Náº¿u thÃªm láº¡i thÃ nh viÃªn Ä‘Ã£ bá»‹ xÃ³a (status = 'removed'):
- Há»‡ thá»‘ng tá»± Ä‘á»™ng RESTORE thÃ nh viÃªn Ä‘Ã³
- KhÃ´ng bÃ¡o lá»—i duplicate
- Cáº­p nháº­t vai trÃ² má»›i vÃ  Ä‘á»•i status thÃ nh 'active'

## Kiáº¿n TrÃºc Ká»¹ Thuáº­t

### Database Schema

**Báº£ng: project_members**
```sql
- id: UUID (Primary Key)
- project_id: INTEGER (Foreign Key to projects.project_id)
- user_id: UUID (Foreign Key to users.id)
- role: TEXT (admin/manager/editor/viewer)
- status: TEXT (active/removed/suspended)
- permissions: JSONB (custom permissions)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
- UNIQUE (project_id, user_id)
```

**Báº£ng: project_roles**
```sql
- id: UUID (Primary Key)
- name: TEXT (admin/manager/editor/viewer)
- level: INTEGER (100/80/60/40)
- display_name: TEXT
- description: TEXT
- permissions: JSONB
```

### Security Functions (SECURITY DEFINER)

Module sá»­ dá»¥ng 5 functions PostgreSQL Ä‘á»ƒ quáº£n lÃ½ quyá»n:

1. **get_available_users_for_project(p_project_id)**
   - Láº¥y danh sÃ¡ch users cÃ³ thá»ƒ thÃªm vÃ o project
   - Lá»c theo level cá»§a ngÆ°á»i dÃ¹ng hiá»‡n táº¡i
   - Admin tháº¥y all, Manager khÃ´ng tháº¥y Admin

2. **add_project_member(p_project_id, p_user_id, p_role, p_custom_permissions)**
   - ThÃªm thÃ nh viÃªn má»›i vÃ o project
   - Tá»± Ä‘á»™ng restore náº¿u Ä‘Ã£ bá»‹ removed
   - Kiá»ƒm tra quyá»n: chá»‰ Admin/Manager Ä‘Æ°á»£c thÃªm

3. **remove_project_member(p_project_id, p_user_id)**
   - XÃ³a thÃ nh viÃªn (soft delete: status = 'removed')
   - Kiá»ƒm tra quyá»n: chá»‰ Admin/Manager Ä‘Æ°á»£c xÃ³a

4. **update_project_member_role(p_project_id, p_user_id, p_new_role)**
   - Cáº­p nháº­t vai trÃ² cá»§a thÃ nh viÃªn
   - Kiá»ƒm tra quyá»n: chá»‰ Admin/Manager Ä‘Æ°á»£c update

5. **get_project_members(p_project_id)**
   - Láº¥y danh sÃ¡ch thÃ nh viÃªn trong project
   - Chá»‰ tráº£ vá» thÃ nh viÃªn cÃ³ status = 'active'

### Row Level Security (RLS)

**Policy: admin_all_access**
- Admin cÃ³ full access (SELECT, INSERT, UPDATE, DELETE)

**Policy: users_view_own_memberships**
- User cÃ³ thá»ƒ SELECT records cá»§a chÃ­nh mÃ¬nh (user_id = auth.uid())

### Service Layer

**File: src/services/projectMemberService.ts**
- Class-based service vá»›i error handling
- Methods: getMembers, addMember, removeMember, updateMemberRole
- Gá»i cÃ¡c SECURITY DEFINER functions

**File: src/services/projectService.ts**
- 2-step query Ä‘á»ƒ load projects:
  1. Get project_ids tá»« project_members
  2. Get projects by project_ids
- TrÃ¡nh dÃ¹ng JOIN do Supabase relationship khÃ´ng hoáº¡t Ä‘á»™ng tá»‘t vá»›i INTEGER FK

### UI Components

**File: src/components/project/ProjectManagement.tsx**
- Hiá»ƒn thá»‹ danh sÃ¡ch projects
- NÃºt "ğŸ‘¥ ThÃ nh viÃªn" chá»‰ hiá»‡n cho Admin/Manager
- Helper: `canManageMembers(project)` kiá»ƒm tra quyá»n

**File: src/components/project/ProjectMembersModal.tsx**
- Modal quáº£n lÃ½ thÃ nh viÃªn
- Filter users theo permission: `filterUsersByPermission()`
- Filter roles theo permission: `filterRolesByPermission()`
- Real-time updates khi thÃªm/xÃ³a/update

## Lá»—i ThÆ°á»ng Gáº·p vÃ  CÃ¡ch Xá»­ LÃ½

### 1. "Authentication timeout"
**NguyÃªn nhÃ¢n:** Cache conflict vá»›i getSession()
**Giáº£i phÃ¡p:** ÄÃ£ fix báº±ng cÃ¡ch dÃ¹ng getUser() thay vÃ¬ getSession()

### 2. "Ambiguous column project_id"
**NguyÃªn nhÃ¢n:** Báº£ng projects cÃ³ cáº£ id (UUID) vÃ  project_id (INTEGER)
**Giáº£i phÃ¡p:** DÃ¹ng table alias (p., pm.) trong queries

### 3. "Duplicate key constraint"
**NguyÃªn nhÃ¢n:** ThÃªm láº¡i user Ä‘Ã£ bá»‹ removed
**Giáº£i phÃ¡p:** Function tá»± Ä‘á»™ng restore thay vÃ¬ bÃ¡o lá»—i

### 4. User khÃ´ng tháº¥y projects sau khi Ä‘Æ°á»£c thÃªm
**NguyÃªn nhÃ¢n:** RLS policy cháº·n SELECT
**Giáº£i phÃ¡p:** ThÃªm policy `users_view_own_memberships`

### 5. Manager tháº¥y Admin users
**NguyÃªn nhÃ¢n:** Function khÃ´ng filter theo role level
**Giáº£i phÃ¡p:** ThÃªm filter trong `get_available_users_for_project`

## Testing Checklist

- [ ] Admin login vÃ  tháº¥y táº¥t cáº£ users
- [ ] Admin cÃ³ thá»ƒ phÃ¢n quyá»n táº¥t cáº£ roles (Admin, Manager, Editor, Viewer)
- [ ] Manager login vÃ  KHÃ”NG tháº¥y Admin users
- [ ] Manager KHÃ”NG tháº¥y Admin role trong dropdown
- [ ] Manager cÃ³ thá»ƒ thÃªm Manager, Editor, Viewer
- [ ] Editor login vÃ  KHÃ”NG tháº¥y nÃºt "ğŸ‘¥ ThÃ nh viÃªn"
- [ ] Viewer login vÃ  KHÃ”NG tháº¥y nÃºt "ğŸ‘¥ ThÃ nh viÃªn"
- [ ] ThÃªm láº¡i user Ä‘Ã£ removed â†’ auto restore thÃ nh cÃ´ng
- [ ] User Ä‘Æ°á»£c thÃªm vÃ o project â†’ login vÃ  tháº¥y project
- [ ] XÃ³a user khá»i project â†’ user khÃ´ng tháº¥y project ná»¯a

## Migration Guide

### Náº¿u CÃ i Äáº·t Má»›i

**BÆ°á»›c 1:** Cháº¡y migrations trong thÆ° má»¥c `migrations/`
```bash
# Cháº¡y theo thá»© tá»±:
1. create_project_roles.sql
2. create_project_members.sql
3. create_project_member_functions.sql
4. fix_all_ambiguous_project_id.sql
5. fix_add_member_with_restore.sql
6. fix_project_members_rls_policy.sql
7. fix_permission_logic_final.sql
```

**BÆ°á»›c 2:** Verify database
```sql
-- Kiá»ƒm tra 4 roles Ä‘Ã£ cÃ³ trong project_roles
SELECT * FROM project_roles ORDER BY level DESC;

-- Kiá»ƒm tra functions Ä‘Ã£ táº¡o
SELECT routine_name FROM information_schema.routines
WHERE routine_schema = 'public'
AND routine_name LIKE '%project_member%';

-- Kiá»ƒm tra RLS policies
SELECT * FROM pg_policies WHERE tablename = 'project_members';
```

**BÆ°á»›c 3:** Deploy frontend code

### Náº¿u Migrate Tá»« Module CÅ©

**LÆ°u Ã½:** Module má»›i Ä‘Æ°á»£c xÃ¢y dá»±ng hoÃ n toÃ n riÃªng biá»‡t, khÃ´ng áº£nh hÆ°á»Ÿng code cÅ©.

**Option 1: Giá»¯ song song**
- Module cÅ© vÃ  má»›i cÃ³ thá»ƒ cháº¡y song song
- Dáº§n migrate dá»¯ liá»‡u sang module má»›i

**Option 2: Migration toÃ n bá»™**
- Backup dá»¯ liá»‡u project_members cÅ©
- Cháº¡y migration scripts
- Verify data integrity

## File Structure

```
src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ project/
â”‚       â”œâ”€â”€ ProjectManagement.tsx          # Danh sÃ¡ch projects + nÃºt Members
â”‚       â””â”€â”€ ProjectMembersModal.tsx        # Modal quáº£n lÃ½ thÃ nh viÃªn
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ projectService.ts                  # Load projects logic
â”‚   â””â”€â”€ projectMemberService.ts            # CRUD operations cho members
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ project.ts                         # Project interface + user_role
â”‚   â”œâ”€â”€ projectRoles.ts                    # Role definitions + mappings
â”‚   â””â”€â”€ userManagement.ts                  # User interfaces
â””â”€â”€ contexts/
    â”œâ”€â”€ AuthContext.tsx                    # User authentication + profile
    â””â”€â”€ ProjectContext.tsx                 # Project state management

migrations/
â”œâ”€â”€ create_project_roles.sql               # Táº¡o báº£ng project_roles
â”œâ”€â”€ create_project_members.sql             # Táº¡o báº£ng project_members
â”œâ”€â”€ create_project_member_functions.sql    # Táº¡o 5 functions
â”œâ”€â”€ fix_all_ambiguous_project_id.sql       # Fix ambiguous column
â”œâ”€â”€ fix_add_member_with_restore.sql        # Auto-restore logic
â”œâ”€â”€ fix_project_members_rls_policy.sql     # RLS policies
â””â”€â”€ fix_permission_logic_final.sql         # Permission filtering
```

## Best Practices

### 1. LuÃ´n sá»­ dá»¥ng SECURITY DEFINER functions
- KhÃ´ng query trá»±c tiáº¿p tá»« frontend
- Functions kiá»ƒm tra quyá»n tá»± Ä‘á»™ng
- Báº£o máº­t tá»‘t hÆ¡n vá»›i RLS

### 2. Soft Delete thay vÃ¬ Hard Delete
- `status = 'removed'` thay vÃ¬ DELETE
- Giá»¯ lá»‹ch sá»­ thÃ nh viÃªn
- CÃ³ thá»ƒ restore dá»… dÃ ng

### 3. Filter á»Ÿ cáº£ Frontend vÃ  Backend
- Frontend: UX tá»‘t hÆ¡n, pháº£n há»“i nhanh
- Backend: Báº£o máº­t cháº¯c cháº¯n
- Defense in depth

### 4. Sá»­ dá»¥ng 2-step query cho relationships
- TrÃ¡nh JOIN phá»©c táº¡p vá»›i Supabase
- Dá»… debug hÆ¡n
- Performance tá»‘t hÆ¡n vá»›i INTEGER FK

## Support

Náº¿u gáº·p váº¥n Ä‘á»:
1. Kiá»ƒm tra console browser Ä‘á»ƒ xem error logs
2. Verify RLS policies trong Supabase dashboard
3. Kiá»ƒm tra functions cÃ³ SECURITY DEFINER
4. Verify user role trong database

## Version History

**v2.0.0 (Current)** - Module hoÃ n toÃ n má»›i
- 4-tier role system (Admin, Manager, Editor, Viewer)
- SECURITY DEFINER functions
- Permission-based filtering
- Auto-restore removed members
- 2-step query pattern

**v1.0.0** - Module cÅ© (deprecated)
- 5 roles (owner, admin, editor, reviewer, viewer)
- Direct queries
- Nhiá»u bugs vá»›i permissions

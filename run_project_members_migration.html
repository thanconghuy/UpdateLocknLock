<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Run Project Members Migration</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    .section h3 {
      margin-top: 0;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
      line-height: 1.6;
    }
    .log-entry {
      margin: 4px 0;
      padding: 4px 0;
    }
    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-warning { color: #fbbf24; }
    .log-info { color: #60a5fa; }
    .steps {
      background: #fff;
      border: 2px solid #667eea;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .steps ol {
      margin: 10px 0;
      padding-left: 20px;
    }
    .steps li {
      margin: 8px 0;
      color: #333;
    }
    .warning-box {
      background: #fef3c7;
      border: 2px solid #fbbf24;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .warning-box strong {
      color: #92400e;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <span>üë•</span>
      Project Members System Migration
    </h1>
    <p class="subtitle">T·∫°o h·ªá th·ªëng qu·∫£n l√Ω th√†nh vi√™n cho projects</p>

    <div class="warning-box">
      <strong>‚ö†Ô∏è Quan tr·ªçng:</strong> Migration n√†y s·∫Ω t·∫°o 2 b·∫£ng m·ªõi (project_roles, project_members) v√† c√°c functions.
      ƒê·∫£m b·∫£o b·∫°n ƒë√£ backup database tr∆∞·ªõc khi ch·∫°y.
    </div>

    <div class="steps">
      <h3>üìã Migration n√†y s·∫Ω th·ª±c hi·ªán:</h3>
      <ol>
        <li>T·∫°o b·∫£ng <code>project_roles</code> v·ªõi 4 roles: admin, manager, editor, viewer</li>
        <li>T·∫°o b·∫£ng <code>project_members</code> ƒë·ªÉ qu·∫£n l√Ω th√†nh vi√™n project</li>
        <li>T·∫°o RLS policies ƒë·ªÉ b·∫£o m·∫≠t d·ªØ li·ªáu</li>
        <li>T·∫°o 4 helper functions: get_user_project_role, get_user_project_permissions, can_user_manage_members, get_project_member_count</li>
        <li>T·∫°o triggers ƒë·ªÉ auto-update timestamp</li>
      </ol>
    </div>

    <div class="section">
      <h3><span>üîß</span> Th·ª±c thi Migration</h3>
      <p>Click n√∫t b√™n d∆∞·ªõi ƒë·ªÉ ch·∫°y migration script:</p>
      <button id="runMigration" onclick="runMigration()">
        <span>üöÄ</span> Ch·∫°y Migration
      </button>
      <div id="log" class="log" style="display: none;"></div>
    </div>

    <div class="section">
      <h3><span>‚úÖ</span> Verification</h3>
      <p>Sau khi migration ho√†n t·∫•t, click ƒë·ªÉ verify:</p>
      <button id="verifyBtn" onclick="verifyMigration()" disabled>
        <span>üîç</span> Ki·ªÉm tra k·∫øt qu·∫£
      </button>
      <div id="verifyLog" class="log" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Supabase config from env.ts
    const SUPABASE_URL = 'https://bfpdvzbcgvtamxcfnybu.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmcGR2emJjZ3Z0YW14Y2ZueWJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyMzg5MjYsImV4cCI6MjA1MTgxNDkyNn0.FbIRDZt6ozP3gwC_d9ZfJGpD-LQi3Nh_pMwzYm4bLms'

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log')
      logDiv.style.display = 'block'
      const entry = document.createElement('div')
      entry.className = `log-entry log-${type}`
      const timestamp = new Date().toLocaleTimeString('vi-VN')
      entry.textContent = `[${timestamp}] ${message}`
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
    }

    function verifyLog(message, type = 'info') {
      const logDiv = document.getElementById('verifyLog')
      logDiv.style.display = 'block'
      const entry = document.createElement('div')
      entry.className = `log-entry log-${type}`
      const timestamp = new Date().toLocaleTimeString('vi-VN')
      entry.textContent = `[${timestamp}] ${message}`
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
    }

    async function runMigration() {
      const btn = document.getElementById('runMigration')
      btn.disabled = true
      document.getElementById('log').innerHTML = ''

      try {
        log('üöÄ B·∫Øt ƒë·∫ßu migration...', 'info')
        log('üìñ ƒê·ªçc file migration...', 'info')

        // Fetch migration SQL file
        const response = await fetch('./migrations/create_project_members_system.sql')
        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ ƒë·ªçc file migration. ƒê·∫£m b·∫£o file t·ªìn t·∫°i trong th∆∞ m·ª•c migrations/')
        }

        const sqlContent = await response.text()
        log('‚úÖ ƒê√£ ƒë·ªçc migration script', 'success')

        // Split by semicolons but keep function bodies intact
        const statements = sqlContent
          .split(/;(?=\s*(?:CREATE|INSERT|ALTER|DROP|COMMENT|SELECT|--|\/\*))/gi)
          .map(s => s.trim())
          .filter(s => s.length > 0 && !s.startsWith('--') && !s.startsWith('/*'))

        log(`üìù T√¨m th·∫•y ${statements.length} statements c·∫ßn th·ª±c thi`, 'info')

        let successCount = 0
        let errorCount = 0

        for (let i = 0; i < statements.length; i++) {
          const statement = statements[i]

          // Skip verification queries
          if (statement.includes('Verify') || statement.includes('verification')) {
            continue
          }

          try {
            const { error } = await supabase.rpc('exec_sql', { sql_query: statement })

            if (error) {
              // Some errors can be ignored (like "already exists")
              if (error.message.includes('already exists') ||
                  error.message.includes('duplicate key')) {
                log(`‚ö†Ô∏è Statement ${i+1}: ƒê√£ t·ªìn t·∫°i, b·ªè qua`, 'warning')
              } else {
                log(`‚ùå Statement ${i+1} l·ªói: ${error.message}`, 'error')
                errorCount++
              }
            } else {
              successCount++
              if ((i + 1) % 10 === 0) {
                log(`‚è≥ ƒê√£ x·ª≠ l√Ω ${i + 1}/${statements.length} statements...`, 'info')
              }
            }
          } catch (err) {
            log(`‚ùå Exception statement ${i+1}: ${err.message}`, 'error')
            errorCount++
          }
        }

        log('', 'info')
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info')
        log(`‚úÖ Ho√†n th√†nh migration!`, 'success')
        log(`   Th√†nh c√¥ng: ${successCount} statements`, 'success')
        if (errorCount > 0) {
          log(`   L·ªói: ${errorCount} statements`, 'error')
        }
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info')
        log('', 'info')
        log('üí° Click "Ki·ªÉm tra k·∫øt qu·∫£" ƒë·ªÉ verify migration', 'info')

        // Enable verify button
        document.getElementById('verifyBtn').disabled = false

      } catch (error) {
        log(`‚ùå L·ªói nghi√™m tr·ªçng: ${error.message}`, 'error')
        log(`üí° B·∫°n c√≥ th·ªÉ ch·∫°y migration th·ªß c√¥ng qua Supabase SQL Editor`, 'warning')
      } finally {
        btn.disabled = false
      }
    }

    async function verifyMigration() {
      document.getElementById('verifyLog').innerHTML = ''

      try {
        verifyLog('üîç Ki·ªÉm tra tables...', 'info')

        // Check project_roles
        const { data: roles, error: rolesError } = await supabase
          .from('project_roles')
          .select('*')
          .order('level', { ascending: false })

        if (rolesError) {
          verifyLog(`‚ùå Kh√¥ng t√¨m th·∫•y b·∫£ng project_roles: ${rolesError.message}`, 'error')
        } else {
          verifyLog(`‚úÖ B·∫£ng project_roles: ${roles.length} roles`, 'success')
          roles.forEach(role => {
            verifyLog(`   - ${role.display_name} (level ${role.level}): ${role.description}`, 'info')
          })
        }

        // Check project_members
        const { count: memberCount, error: membersError } = await supabase
          .from('project_members')
          .select('*', { count: 'exact', head: true })

        if (membersError) {
          verifyLog(`‚ùå Kh√¥ng t√¨m th·∫•y b·∫£ng project_members: ${membersError.message}`, 'error')
        } else {
          verifyLog(`‚úÖ B·∫£ng project_members: ${memberCount || 0} members hi·ªán c√≥`, 'success')
        }

        // Check functions
        verifyLog('', 'info')
        verifyLog('üîç Ki·ªÉm tra functions...', 'info')

        const functions = [
          'get_user_project_role',
          'get_user_project_permissions',
          'can_user_manage_members',
          'get_project_member_count'
        ]

        for (const funcName of functions) {
          try {
            // Try to call function with dummy params to test if it exists
            const { error } = await supabase.rpc(funcName,
              funcName.includes('count') ? { p_project_id: 0 } : { p_project_id: 0, p_user_id: '00000000-0000-0000-0000-000000000000' }
            )

            if (error && !error.message.includes('not found')) {
              verifyLog(`‚úÖ Function ${funcName} t·ªìn t·∫°i`, 'success')
            } else if (error && error.message.includes('not found')) {
              verifyLog(`‚ùå Function ${funcName} kh√¥ng t·ªìn t·∫°i`, 'error')
            } else {
              verifyLog(`‚úÖ Function ${funcName} t·ªìn t·∫°i`, 'success')
            }
          } catch (err) {
            verifyLog(`‚ùå Function ${funcName}: ${err.message}`, 'error')
          }
        }

        verifyLog('', 'info')
        verifyLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success')
        verifyLog('‚úÖ Verification ho√†n t·∫•t!', 'success')
        verifyLog('üí° B√¢y gi·ªù c√≥ th·ªÉ s·ª≠ d·ª•ng module Project Members', 'success')
        verifyLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success')

      } catch (error) {
        verifyLog(`‚ùå L·ªói khi verify: ${error.message}`, 'error')
      }
    }
  </script>
</body>
</html>

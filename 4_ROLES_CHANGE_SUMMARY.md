# üìù T√ìM T·∫ÆT THAY ƒê·ªîI: ƒê·ªíNG B·ªò 4 C·∫§P ƒê·ªò PH√ÇN QUY·ªÄN

> **Ng√†y c·∫≠p nh·∫≠t:** 2025-10-02
> **M·ª•c ƒë√≠ch:** ƒê·ªìng b·ªô ph√¢n quy·ªÅn gi·ªØa System Level v√† Project Level v·ªÅ 4 c·∫•p ƒë·ªô gi·ªëng nhau

---

## üéØ M·ª§C TI√äU THAY ƒê·ªîI

### Tr∆∞·ªõc ƒë√¢y (Code c≈©)
- ‚ùå System Roles: 4 c·∫•p ƒë·ªô (admin, manager, editor, viewer)
- ‚ùå Project Roles: 5 c·∫•p ƒë·ªô (admin, manager, **product_editor**, **project_viewer**, viewer)
- ‚ùå Kh√¥ng ƒë·ªìng b·ªô, g√¢y kh√≥ hi·ªÉu v√† ph·ª©c t·∫°p trong code

### Sau khi thay ƒë·ªïi (Code m·ªõi)
- ‚úÖ System Roles: 4 c·∫•p ƒë·ªô (admin, manager, editor, viewer)
- ‚úÖ Project Roles: 4 c·∫•p ƒë·ªô (admin, manager, editor, viewer)
- ‚úÖ ƒê·ªìng b·ªô ho√†n to√†n, d·ªÖ hi·ªÉu v√† maintain

---

## üîÑ CHI TI·∫æT THAY ƒê·ªîI

### 1. Thay ƒë·ªïi Project Roles

#### BEFORE (5 roles):
```typescript
'admin'          ‚Üí Level 100
'manager'        ‚Üí Level 80
'product_editor' ‚Üí Level 60  // ‚ùå X√≥a
'project_viewer' ‚Üí Level 40  // ‚ùå X√≥a
'viewer'         ‚Üí Level 20  // ‚ùå Level 20 ‚Üí 40
```

#### AFTER (4 roles):
```typescript
'admin'    ‚Üí Level 100  // ‚úÖ Mapping v·ªõi System admin
'manager'  ‚Üí Level 80   // ‚úÖ Mapping v·ªõi System manager
'editor'   ‚Üí Level 60   // ‚úÖ Mapping v·ªõi System editor (thay product_editor)
'viewer'   ‚Üí Level 40   // ‚úÖ Mapping v·ªõi System viewer (n√¢ng t·ª´ 20 l√™n 40)
```

### 2. Mapping Logic

| System Role | Can Assign Project Roles | Default Project Role |
|-------------|-------------------------|---------------------|
| admin | admin, manager, editor, viewer | admin |
| manager | manager, editor, viewer | manager |
| editor | editor, viewer | editor |
| viewer | viewer | viewer |

**Nguy√™n t·∫Øc:**
- ‚úÖ System role quy·∫øt ƒë·ªãnh quy·ªÅn t·ªëi ƒëa trong project
- ‚úÖ C√≥ th·ªÉ assign project role ‚â§ system role level
- ‚ùå Kh√¥ng th·ªÉ assign project role > system role level
- ‚úÖ T√™n role gi·ªëng nhau ‚Üí D·ªÖ hi·ªÉu, d·ªÖ maintain

---

## üìä SO S√ÅNH PERMISSIONS

### Admin (Level 100)
```json
{
  "can_edit_project": true,
  "can_delete_project": true,
  "can_manage_members": true,
  "can_edit_products": true,
  "can_manage_woocommerce": true,
  "can_view_analytics": true
}
```

### Manager (Level 80)
```json
{
  "can_edit_project": true,
  "can_delete_project": false,        // ‚ùå Kh√¥ng x√≥a project
  "can_manage_members": true,
  "can_edit_products": true,
  "can_manage_woocommerce": true,
  "can_view_analytics": true
}
```

### Editor (Level 60) - Thay th·∫ø product_editor
```json
{
  "can_edit_project": false,
  "can_delete_project": false,
  "can_manage_members": false,
  "can_edit_products": true,          // ‚úÖ Ch·ªânh s·ª≠a products
  "can_manage_woocommerce": true,     // ‚úÖ Sync WooCommerce
  "can_view_analytics": true
}
```

### Viewer (Level 40) - H·ª£p nh·∫•t project_viewer
```json
{
  "can_edit_project": false,
  "can_delete_project": false,
  "can_manage_members": false,
  "can_edit_products": false,
  "can_manage_woocommerce": false,
  "can_view_analytics": true          // ‚úÖ Xem analytics
}
```

---

## üóÇÔ∏è FILES ƒê√É T·∫†O/C·∫¨P NH·∫¨T

### 1. Database Migration
**File:** `migrations/20251002_create_4_project_roles.sql`
- ‚úÖ Drop old project_roles table
- ‚úÖ Create new v·ªõi 4 roles
- ‚úÖ Insert 4 roles v·ªõi permissions ƒë√∫ng
- ‚úÖ Enable RLS

### 2. TypeScript Types
**File:** `src/types/projectRoles.ts` (M·ªöI)
- ‚úÖ `ProjectRoleName` type: 'admin' | 'manager' | 'editor' | 'viewer'
- ‚úÖ `PROJECT_ROLE_LEVELS` constants
- ‚úÖ `ProjectRole` interface
- ‚úÖ `ProjectPermissions` interface
- ‚úÖ `SYSTEM_TO_PROJECT_ROLE_MAPPING` mapping logic
- ‚úÖ Helper functions: `canAssignRole()`, `getAssignableRoles()`, `getDefaultProjectRole()`

### 3. Documentation
**File:** `PROJECT_MEMBERS_ANALYSIS.md` (C·∫¨P NH·∫¨T)
- ‚úÖ Section 2.3: Updated to 4 roles
- ‚úÖ Section 5.1: ƒê·ªìng b·ªô System v√† Project levels
- ‚úÖ Th√™m mapping table v√† nguy√™n t·∫Øc

---

## üöÄ C√ÅCH S·ª¨ D·ª§NG

### 1. Ch·∫°y Migration
```sql
-- Ch·∫°y trong Supabase SQL Editor
\i migrations/20251002_create_4_project_roles.sql
```

### 2. Verify Roles
```sql
SELECT id, name, display_name, level
FROM project_roles
ORDER BY level DESC;

-- Expected output:
-- id | name    | display_name    | level
-- ---|---------|-----------------|------
-- 1  | admin   | Qu·∫£n tr·ªã vi√™n   | 100
-- 2  | manager | Ng∆∞·ªùi qu·∫£n l√Ω   | 80
-- 3  | editor  | Bi√™n t·∫≠p vi√™n   | 60
-- 4  | viewer  | Ng∆∞·ªùi xem       | 40
```

### 3. S·ª≠ d·ª•ng trong Code

#### Import types:
```typescript
import {
  ProjectRoleName,
  ProjectRole,
  ProjectPermissions,
  canAssignRole,
  getAssignableRoles,
  getDefaultProjectRole
} from '@/types/projectRoles'
```

#### Check if can assign role:
```typescript
const userSystemRole = 'manager' // User's system role
const targetProjectRole = 'admin' // Role to assign

if (canAssignRole(userSystemRole, targetProjectRole)) {
  // OK: Manager c√≥ th·ªÉ assign manager/editor/viewer
  // ‚ùå Error: Manager kh√¥ng th·ªÉ assign admin
} else {
  throw new Error('Cannot assign role higher than your level')
}
```

#### Get assignable roles for dropdown:
```typescript
const userSystemRole = 'editor'
const assignableRoles = getAssignableRoles(userSystemRole)
// Returns: ['editor', 'viewer']

// Render dropdown:
assignableRoles.map(role => (
  <option value={role}>{role}</option>
))
```

#### Get default project role:
```typescript
const userSystemRole = 'manager'
const defaultRole = getDefaultProjectRole(userSystemRole)
// Returns: 'manager'
```

---

## ‚ö†Ô∏è BREAKING CHANGES

### 1. Database
- ‚ùå **X√≥a roles:** `product_editor`, `project_viewer`
- ‚úÖ **Th√™m role m·ªõi:** `editor` (thay product_editor)
- ‚ö†Ô∏è **L∆∞u √Ω:** N·∫øu c√≥ data c≈© v·ªõi `product_editor` ho·∫∑c `project_viewer`, c·∫ßn migrate:

```sql
-- Migrate old roles to new roles
UPDATE project_members
SET role = 'editor'
WHERE role = 'product_editor';

UPDATE project_members
SET role = 'viewer'
WHERE role IN ('project_viewer', 'viewer');
```

### 2. TypeScript Code
- ‚ùå **Old type:**
  ```typescript
  role: 'admin' | 'manager' | 'product_editor' | 'project_viewer' | 'viewer'
  ```
- ‚úÖ **New type:**
  ```typescript
  role: 'admin' | 'manager' | 'editor' | 'viewer'
  ```

### 3. Frontend Components
C·∫≠p nh·∫≠t t·∫•t c·∫£ components s·ª≠ d·ª•ng project roles:
- ‚úÖ Import `ProjectRoleName` t·ª´ `@/types/projectRoles`
- ‚úÖ Thay `product_editor` ‚Üí `editor`
- ‚úÖ Thay `project_viewer` ‚Üí `viewer`
- ‚úÖ Update dropdowns v√† conditional rendering

---

## ‚úÖ CHECKLIST MIGRATION

### Pre-migration
- [ ] Backup database
- [ ] Backup code (git commit)
- [ ] Review t√†i li·ªáu n√†y

### Migration Steps
- [ ] Ch·∫°y migration `20251002_create_4_project_roles.sql`
- [ ] Verify 4 roles ƒë∆∞·ª£c t·∫°o ƒë√∫ng
- [ ] Migrate old data (n·∫øu c√≥):
  ```sql
  UPDATE project_members SET role = 'editor' WHERE role = 'product_editor';
  UPDATE project_members SET role = 'viewer' WHERE role IN ('project_viewer', 'viewer');
  ```
- [ ] Check kh√¥ng c√≤n old roles trong database:
  ```sql
  SELECT DISTINCT role FROM project_members;
  -- Should only return: admin, manager, editor, viewer
  ```

### Code Updates
- [ ] Update TypeScript interfaces
- [ ] Update components s·ª≠ d·ª•ng roles
- [ ] Update service layer
- [ ] Update permission checks
- [ ] Run TypeScript compile: `npm run build`
- [ ] Fix any type errors

### Testing
- [ ] Test v·ªõi m·ªói role (admin, manager, editor, viewer)
- [ ] Test assign roles (check mapping logic)
- [ ] Test permissions cho m·ªói role
- [ ] Test UI rendering ƒë√∫ng

### Post-migration
- [ ] Monitor production logs
- [ ] Gather user feedback
- [ ] Update documentation

---

## üìö T√ÄI LI·ªÜU LI√äN QUAN

1. [PROJECT_MEMBERS_ANALYSIS.md](PROJECT_MEMBERS_ANALYSIS.md) - Ph√¢n t√≠ch to√†n di·ªán h·ªá th·ªëng
2. [migrations/20251002_create_4_project_roles.sql](migrations/20251002_create_4_project_roles.sql) - Migration script
3. [src/types/projectRoles.ts](src/types/projectRoles.ts) - TypeScript types v√† helpers

---

## üîç EXAMPLES

### Example 1: Admin assigns roles
```typescript
// Admin c√≥ th·ªÉ assign b·∫•t k·ª≥ role n√†o
const adminSystemRole = 'admin'
canAssignRole(adminSystemRole, 'admin')    // ‚úÖ true
canAssignRole(adminSystemRole, 'manager')  // ‚úÖ true
canAssignRole(adminSystemRole, 'editor')   // ‚úÖ true
canAssignRole(adminSystemRole, 'viewer')   // ‚úÖ true
```

### Example 2: Manager assigns roles
```typescript
// Manager ch·ªâ assign ƒë∆∞·ª£c manager tr·ªü xu·ªëng
const managerSystemRole = 'manager'
canAssignRole(managerSystemRole, 'admin')    // ‚ùå false
canAssignRole(managerSystemRole, 'manager')  // ‚úÖ true
canAssignRole(managerSystemRole, 'editor')   // ‚úÖ true
canAssignRole(managerSystemRole, 'viewer')   // ‚úÖ true
```

### Example 3: Editor assigns roles
```typescript
// Editor ch·ªâ assign ƒë∆∞·ª£c editor ho·∫∑c viewer
const editorSystemRole = 'editor'
canAssignRole(editorSystemRole, 'admin')    // ‚ùå false
canAssignRole(editorSystemRole, 'manager')  // ‚ùå false
canAssignRole(editorSystemRole, 'editor')   // ‚úÖ true
canAssignRole(editorSystemRole, 'viewer')   // ‚úÖ true
```

### Example 4: Viewer assigns roles
```typescript
// Viewer ch·ªâ assign ƒë∆∞·ª£c viewer
const viewerSystemRole = 'viewer'
canAssignRole(viewerSystemRole, 'admin')    // ‚ùå false
canAssignRole(viewerSystemRole, 'manager')  // ‚ùå false
canAssignRole(viewerSystemRole, 'editor')   // ‚ùå false
canAssignRole(viewerSystemRole, 'viewer')   // ‚úÖ true
```

---

## üí° L·ª¢I √çCH C·ª¶A VI·ªÜC ƒê·ªíNG B·ªò

### 1. ƒê∆°n gi·∫£n h√≥a Code
- ‚úÖ C√πng t√™n role ‚Üí D·ªÖ map, d·ªÖ hi·ªÉu
- ‚úÖ Gi·∫£m confusion gi·ªØa system v√† project roles
- ‚úÖ Code ng·∫Øn g·ªçn, maintainable h∆°n

### 2. D·ªÖ Scale
- ‚úÖ Th√™m role m·ªõi: Th√™m ·ªü c·∫£ 2 n∆°i v·ªõi c√πng t√™n
- ‚úÖ S·ª≠a permissions: S·ª≠a ·ªü 1 n∆°i, apply cho c·∫£ 2
- ‚úÖ Clear separation of concerns

### 3. Better UX
- ‚úÖ User d·ªÖ hi·ªÉu: "B·∫°n l√† manager ·ªü h·ªá th·ªëng ‚Üí manager trong project"
- ‚úÖ √çt l·ªói h∆°n: Kh√¥ng th·ªÉ assign sai role
- ‚úÖ Predictable behavior

### 4. Type Safety
- ‚úÖ TypeScript compile-time checking
- ‚úÖ Auto-complete trong IDE
- ‚úÖ Catch errors s·ªõm

---

**üéâ Ho√†n th√†nh ƒë·ªìng b·ªô 4 c·∫•p ƒë·ªô ph√¢n quy·ªÅn!**
